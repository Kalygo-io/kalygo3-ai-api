apiVersion: serving.knative.dev/v1
kind: Service
metadata:
  name: kalygo-fastapi-service
spec:
  template:
    spec:
      containers:
        - image: us-central1-docker.pkg.dev/kalygo-436411/kalygo-fastapi/kalygo-fastapi
          resources:
            limits:
              memory: "4Gi" # Sufficient for 100 concurrent requests with LLM operations
              cpu: "4" # 4 vCPU for handling concurrent requests efficiently
            requests:
              memory: "2Gi" # Minimum memory request
              cpu: "2" # Minimum CPU request
          # Health check configuration
          # Startup probe: More lenient to allow app to fully start (FastAPI + DB connections)
          startupProbe:
            httpGet:
              path: / # Health check endpoint (returns {"status": "OK!"})
              port: 8080
            initialDelaySeconds: 10  # Wait 10s before first check (allows app to start)
            timeoutSeconds: 5  # 5s timeout per check
            periodSeconds: 5  # Check every 5s
            failureThreshold: 12  # Allow up to 60s total startup time (12 × 5s)
          # Liveness probe: Check periodically after startup
          livenessProbe:
            httpGet:
              path: / # Health check endpoint
              port: 8080
            initialDelaySeconds: 0
            timeoutSeconds: 3  # 3s timeout per check
            periodSeconds: 30  # Check every 30s (less frequent)
            failureThreshold: 3  # Restart after 3 failures
          env:
            - name: POSTGRES_URL
              valueFrom:
                secretKeyRef:
                  name: POSTGRES_URL
                  key: latest

            - name: COHERE_API_KEY
              valueFrom:
                secretKeyRef:
                  name: COHERE_API_KEY
                  key: latest

            - name: REPLICATE_API_TOKEN
              valueFrom:
                secretKeyRef:
                  name: REPLICATE_API_TOKEN
                  key: latest

            - name: ANTHROPIC_API_KEY
              valueFrom:
                secretKeyRef:
                  name: ANTHROPIC_API_KEY
                  key: latest

            - name: OPENAI_API_KEY
              valueFrom:
                secretKeyRef:
                  name: OPENAI_API_KEY
                  key: latest

            - name: AUTH_SECRET_KEY
              valueFrom:
                secretKeyRef:
                  name: AUTH_SECRET_KEY
                  key: latest
            - name: AUTH_ALGORITHM
              valueFrom:
                secretKeyRef:
                  name: AUTH_ALGORITHM
                  key: latest

            # Langchain/Langsmith

            - name: LANGSMITH_ENDPOINT
              valueFrom:
                secretKeyRef:
                  name: LANGSMITH_ENDPOINT
                  key: latest

            - name: LANGSMITH_API_KEY
              valueFrom:
                secretKeyRef:
                  name: LANGSMITH_API_KEY
                  key: latest

            # CORS rule

            - name: COOKIE_DOMAIN
              valueFrom:
                secretKeyRef:
                  name: COOKIE_DOMAIN
                  key: latest

            # AWS

            - name: AWS_REGION
              valueFrom:
                secretKeyRef:
                  name: AWS_REGION
                  key: latest

            - name: AWS_ACCESS_KEY_ID
              valueFrom:
                secretKeyRef:
                  name: AWS_ACCESS_KEY_ID
                  key: latest

            - name: AWS_SECRET_KEY
              valueFrom:
                secretKeyRef:
                  name: AWS_SECRET_KEY
                  key: latest

            - name: ENVIRONMENT
              valueFrom:
                secretKeyRef:
                  name: ENVIRONMENT
                  key: latest

            - name: KB_INGEST_SA
              valueFrom:
                secretKeyRef:
                  name: KB_INGEST_SA
                  key: latest

            - name: API_HOSTNAME
              valueFrom:
                secretKeyRef:
                  name: API_HOSTNAME
                  key: latest

            # - name: SERPER_API_KEY
            #   valueFrom:
            #     secretKeyRef:
            #       name: SERPER_API_KEY
            #       key: latest

            - name: EMBEDDINGS_API_URL
              valueFrom:
                secretKeyRef:
                  name: EMBEDDINGS_API_URL
                  key: latest

            # Pinecone

            - name: PINECONE_API_KEY
              valueFrom:
                secretKeyRef:
                  name: PINECONE_API_KEY
                  key: latest

            - name: PINECONE_ALL_MINILM_L6_V2_INDEX
              valueFrom:
                secretKeyRef:
                  name: PINECONE_ALL_MINILM_L6_V2_INDEX
                  key: latest

            - name: PINECONE_IMAGEBIND_1024_DIMS_INDEX
              valueFrom:
                secretKeyRef:
                  name: PINECONE_IMAGEBIND_1024_DIMS_INDEX
                  key: latest

            # Google Cloud Storage and PubSub
            - name: GCS_BUCKET_NAME
              value: "kalygo-kb-ingest-storage"

            - name: GOOGLE_CLOUD_PROJECT
              value: "kalygo-436411"

            # Stripe

            - name: STRIPE_SECRET_KEY
              valueFrom:
                secretKeyRef:
                  name: STRIPE_SECRET_KEY
                  key: latest

            # Reranker

            - name: RERANKER_API_URL
              valueFrom:
                secretKeyRef:
                  name: RERANKER_API_URL
                  key: latest

            - name: CREDENTIALS_ENCRYPTION_KEY
              valueFrom:
                secretKeyRef:
                  name: CREDENTIALS_ENCRYPTION_KEY
                  key: latest

            # Database connection pool configuration
            # Optimized for Cloud Run with 100 concurrent requests per instance
            # Pro tier: 200 DB connections. With PgBouncer transaction pooling:
            # - 30 client connections per instance × 100 max instances = 3,000 client connections
            # - PgBouncer pools these efficiently: ~2-3 actual DB connections per instance at peak
            # - 100 instances × 2 DB connections = ~200 DB connections (matches Pro tier limit)
            - name: DB_POOL_SIZE
              value: "20" # Base pool size per instance (conservative for multi-instance scaling)
            - name: DB_MAX_OVERFLOW
              value: "10" # Additional connections when pool is exhausted
            - name: DB_POOL_TIMEOUT
              value: "30" # Seconds to wait for connection
            - name: DB_POOL_RECYCLE
              value: "300" # Recycle connections every 5 minutes

          ports:
            - containerPort: 8080
